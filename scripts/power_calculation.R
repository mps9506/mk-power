## This script is a power calculation to
## determing the number of samples needed
## for a seasonal kendall test for trend

## calculating power for detection of a 20% change in
## log transformed e.coli meaurements over 7 years with 
## between 2 and 10 samples per year

library(dplyr)
library(furrr)
library(fitdistrplus)
library(ggplot2)

#### data ####
dist.data <- structure(list(ResultMeasureValue = c(3.98898404656427, 4.21950770517611, 
                                                   3.3322045101752, 5.39362754635236, 5.82894561761021, 6.75693238924755, 
                                                   6.17378610390194, 6.19440539110467, 4.9416424226093, 4.9416424226093, 
                                                   4.78749174278205, 5.13579843705026, 6.01615715969835, 4.78749174278205, 
                                                   4.9416424226093, 4.47733681447821, 4.9416424226093, 4.9416424226093, 
                                                   6.32793678372919, 7.17011954344963, 4.58496747867057, 4.43081679884331, 
                                                   3.63758615972639, 4.31748811353631, 4.60517018598809, 5.96614673912369, 
                                                   5.07517381523383, 4.43081679884331, 6.76849321164863, 5.52146091786225, 
                                                   5.01063529409626, 3.71357206670431, 5.24702407216049, 4.70048036579242, 
                                                   5.56068163101553, 5.79909265446053, 4.51085950651685, 5.48063892334199, 
                                                   6.76849321164863, 5.13579843705026, 7.54960916515453, 6.19440539110467, 
                                                   6.41345895716736, 4.60517018598809, 4.60517018598809, 5.07517381523383, 
                                                   4.0943445622221, 4.34380542185368, 4.31748811353631, 4.53259949315326, 
                                                   3.95124371858143, 4.45434729625351, 5.01063529409626, 4.34380542185368, 
                                                   4.51085950651685, 6.08677472691231, 5.34710753071747, 4.56434819146784, 
                                                   4.78749174278205, 7.3132203870903, 5.13579843705026, 4.70048036579242, 
                                                   4.60517018598809, 4.27666611901606, 4.15888308335967, 5.34710753071747, 
                                                   5.73657229747919, 4.70048036579242, 5.13579843705026, 6.82437367004309, 
                                                   5.4380793089232, 5.66988092298052, 5.29831736654804, 5.29831736654804, 
                                                   5.13579843705026, 5.82894561761021, 5.19295685089021, 6.36302810354046, 
                                                   5.73657229747919, 5.19295685089021, 5.29831736654804, 4.39444915467244, 
                                                   4.78749174278205, 6.59304453414244, 4.47733681447821, 4.86753445045558, 
                                                   5.13579843705026, 5.29831736654804, 5.52146091786225, 4.53259949315326, 
                                                   5.73657229747919, 5.66988092298052, 5.29831736654804, 3.78418963391826, 
                                                   5.29831736654804, 6.25382881157547, 3.76120011569356, 7.78322401633604, 
                                                   7.37775890822787, 5.07517381523383, 5.96614673912369, 6.30991827822652, 
                                                   4.86753445045558, 6.5366915975913, 4.9416424226093, 4.70048036579242, 
                                                   5.39362754635236, 4.18965474202643, 4.86753445045558, 3.25809653802148, 
                                                   4.39444915467244, 3.46573590279973, 3.97029191355212, 3.89182029811063, 
                                                   4.02535169073515, 4.70048036579242, 4.9416424226093, 4.9416424226093, 
                                                   4.53259949315326, 4.60517018598809, 5.34710753071747, 4.56434819146784, 
                                                   5.13579843705026, 4.9416424226093, 5.13579843705026, 5.48063892334199, 
                                                   4.60517018598809, 5.07517381523383, 4.9416424226093, 4.78749174278205, 
                                                   9.47270463644367, 5.48063892334199, 7.78322401633604, 5.13579843705026, 
                                                   5.13579843705026, 4.60517018598809, 4.60517018598809, 4.70048036579242, 
                                                   4.31748811353631, 5.52146091786225, 5.91350300563827, 4.26267987704132, 
                                                   4.53259949315326, 4.9416424226093, 5.91350300563827, 5.13579843705026, 
                                                   4.9416424226093, 5.13579843705026, 5.4380793089232, 3.17805383034795, 
                                                   4.30406509320417, 5.01063529409626, 4.29045944114839, 4.86753445045558, 
                                                   4.56434819146784, 5.82894561761021, 6.7093043402583, 5.66988092298052, 
                                                   5.01063529409626, 9.39266192877014, 4.9416424226093, 4.70048036579242, 
                                                   4.60517018598809, 5.96614673912369, 5.34710753071747, 4.60517018598809, 
                                                   7.24422751560335, 4.43081679884331, 5.56068163101553, 4.70048036579242, 
                                                   4.17438726989564, 3.80666248977032, 4.86753445045558, 4.70048036579242, 
                                                   7.09007683577609, 7.00306545878646, 6.47697236288968, 4.9416424226093, 
                                                   5.63478960316925, 7.00306545878646, 6.47697236288968, 6.62007320653036, 
                                                   5.73657229747919, 7.60090245954208, 7.49554194388426, 5.56068163101553, 
                                                   4.9416424226093, 7.09007683577609, 5.94017125272043, 5.13579843705026, 
                                                   4.86753445045558, 4.45434729625351, 4.78749174278205, 4.31748811353631, 
                                                   3.97029191355212, 4.70048036579242, 4.23410650459726, 5.07517381523383, 
                                                   5.01063529409626, 4.47733681447821, 5.01063529409626, 5.79909265446053, 
                                                   5.29831736654804, 4.30406509320417, 4.70048036579242, 5.24702407216049, 
                                                   4.86753445045558, 6.90775527898214, 7.24422751560335, 5.82894561761021, 
                                                   5.56068163101553, 5.13579843705026, 6.64639051484773, 4.70048036579242, 
                                                   6.64639051484773, 5.52146091786225, 5.82894561761021, 5.91350300563827, 
                                                   5.24702407216049, 4.60517018598809, 5.19295685089021, 5.52146091786225, 
                                                   4.78749174278205, 5.73657229747919, 9.21034037197618, 5.79909265446053, 
                                                   7.37775890822787, 5.79909265446053, 6.41345895716736, 5.07517381523383, 
                                                   5.24702407216049, 5.19295685089021, 7.60090245954208, 6.41345895716736, 
                                                   6.13122648948314, 5.4380793089232, 8.83927669058535, 6.47697236288968, 
                                                   10.9150884642146, 5.56068163101553, 4.9416424226093, 4.56434819146784, 
                                                   6.08677472691231, 4.70048036579242, 4.35670882668959, 4.47733681447821, 
                                                   3.97029191355212, 5.34710753071747, 3.89182029811063, 9.07107830464268, 
                                                   5.24702407216049, 8.38935981990635, 7.78322401633604, 5.52146091786225, 
                                                   5.29831736654804, 8.26873183211774, 6.36302810354046, 5.29831736654804, 
                                                   5.4380793089232, 5.59842195899838, 5.96614673912369, 7.43838353004431, 
                                                   6.08677472691231, 5.4380793089232, 5.56068163101553, 9.07107830464268, 
                                                   6.59304453414244, 5.52146091786225, 5.34710753071747, 5.24702407216049, 
                                                   5.07517381523383, 6.5366915975913, 5.96614673912369, 4.78749174278205, 
                                                   5.48063892334199, 6.08677472691231, 7.78322401633604, 5.96614673912369, 
                                                   7.24422751560335, 5.73657229747919, 5.79909265446053, 6.19440539110467, 
                                                   6.01615715969835, 8.55641390456952, 5.99146454710798, 5.19295685089021, 
                                                   5.13579843705026, 5.52146091786225, 7.09007683577609, 7.24422751560335, 
                                                   6.01615715969835, 5.24702407216049, 4.60517018598809, 6.64639051484773, 
                                                   5.39362754635236, 4.70048036579242, 4.59511985013459, 5.01063529409626, 
                                                   4.40671924726425, 7.17011954344963, 4.9416424226093, 4.47733681447821, 
                                                   6.47697236288968, 4.78749174278205, 4.31748811353631, 4.70048036579242, 
                                                   6.04025471127741, 6.59304453414244, 4.70048036579242, 4.43081679884331, 
                                                   4.43081679884331, 5.24702407216049, 4.21950770517611, 5.07517381523383, 
                                                   4.78749174278205, 4.18965474202643, 5.96614673912369, 4.78749174278205, 
                                                   6.13122648948314, 4.86753445045558, 4.56434819146784, 3.80666248977032, 
                                                   5.19295685089021, 4.04305126783455, 4.60517018598809, 4.78749174278205, 
                                                   4.70048036579242, 6.08677472691231, 6.44571981938558, 5.24702407216049, 
                                                   4.38202663467388, 5.52146091786225, 5.66988092298052, 5.91350300563827, 
                                                   5.19295685089021, 5.79909265446053, 4.9416424226093, 5.24702407216049, 
                                                   5.24702407216049, 5.24702407216049, 7.24422751560335, 5.07517381523383, 
                                                   4.86753445045558, 5.73657229747919, 6.30991827822652, 5.29831736654804, 
                                                   5.07517381523383, 4.70048036579242, 4.07753744390572, 5.07517381523383, 
                                                   4.60517018598809, 6.13122648948314, 5.48063892334199, 5.29831736654804, 
                                                   5.82894561761021, 5.52146091786225, 8.7160440501614, 5.56068163101553, 
                                                   6.90775527898214, 6.47697236288968, 5.4380793089232, 8.49699048409872, 
                                                   8.83927669058535, 5.66988092298052, 4.78749174278205, 6.7093043402583, 
                                                   5.34710753071747, 3.49650756146648, 4.78749174278205, 7.00306545878646, 
                                                   4.86753445045558, 5.24702407216049)), class = c("spec_tbl_df", 
                                                                                                   "tbl_df", "tbl", "data.frame"), row.names = c(NA, -372L))

#### functions ####


## generates a vector starting at mean mu and desired percent change over n-years
generate_trend <- function(mu, percent_change, n_years) {
  change <- mu*percent_change/100
  i <- 1:n_years
  b <- change/(n_years-1)
  mu <- mu + (i-1) * b
  x <- tibble(i = i,
              mu = mu)
  return(x)
}

## simulates lognormal data with for n samples per year with mean mu trending as
## specified in generate_trend
generate_random_data <- function(trend, samples_per_year, sd) {

  trend %>% 
    mutate(samples = purrr::map(mu,
                                  ~{tibble(n_sample = 1:samples_per_year,
                                           monthly_sample = rlnorm(samples_per_year, .x, sd))})) %>%
    tidyr::unnest(samples) %>%
    mutate(t = i + ((n_sample-1)/samples_per_year)) %>%
    dplyr::select(t, monthly_sample)

}

#### fit distributions to sample site data ####
png(file = "plotdist.png", width = 6, height = 4, units = "in", res = 96)
plotdist(dist.data$ResultMeasureValue, histo = TRUE, demp = TRUE)
dev.off()
descdist(dist.data$ResultMeasureValue, boot = 1000)


fw <- fitdist(dist.data$ResultMeasureValue, "weibull")
fln <- fitdist(dist.data$ResultMeasureValue, "lnorm")
fg <- fitdist(dist.data$ResultMeasureValue, "gamma")

png(file = "fitdist.png", width = 6, height = 6, units = "in", res = 96)
par(mfrow = c(2, 2))
plot.legend <- c("Weibull", "lognormal", "gamma")

denscomp(list(fw, fln, fg), legendtext = plot.legend)
qqcomp(list(fw, fln, fg), legendtext = plot.legend)
cdfcomp(list(fw, fln, fg), legendtext = plot.legend)
ppcomp(list(fw, fln, fg), legendtext = plot.legend)
dev.off()
## probably lognormal
summary(fw)
summary(fg)
summary(fln) ## fln looks most reasonable by plot and AIC

## get the sample distribution parameters
mu <- fln$estimate["meanlog"]
sd <- fln$estimate["sdlog"]


## number of resamples
r <- 10000

## percent change to detect
percent_change = -20

## estimated mean and sd
mu <- fln$estimate["meanlog"]
sd <- fln$estimate["sdlog"]

power_ken <- function(r, mu, percent_change, n_years, samples_per_year) {
  tibble(r = 1:r) %>%
    mutate(n_years = n_years,
           samples_per_year = samples_per_year) %>%
    mutate(trend = purrr::map(n_years, 
                              ~generate_trend(mu = mu, percent_change = percent_change, n_years = .x)),
           random_data = purrr::map2(trend, samples_per_year,
                                     ~generate_random_data(.x, .y, sd)), 
           mk_test = purrr::map(random_data,
                                ~smwrStats::kensen.test(.x$monthly_sample, .x$t, n.min = Inf)),
           p_value = purrr::map_dbl(mk_test,
                                    "p.value")) -> df
  power <- nrow(df %>% filter(p_value <= 0.1))/r
  return(power)
}

samples_per_year <- c(2,3,4,5,6,7,8,10)


output <- tibble(n_years = rep(7, length(samples_per_year)),
                 samples_per_year = samples_per_year) %>%
  mutate(power = furrr::future_map2(n_years, samples_per_year,
                                    ~power_ken(r, mu, percent_change,
                                               .x, .y)))
output %>% tidyr::unnest(power) -> output

output %>% mutate(p.change = percent_change) -> output.20


ggplot(output.20) +
  geom_point(aes(samples_per_year, power)) +
  geom_line(aes(samples_per_year, power))
ggsave("example.png", width = 4, height = 2, units = "in", dpi = 200)

plan(multiprocess)
percent_change = -15
output <- tibble(n_years = rep(7, length(samples_per_year)),
                 samples_per_year = samples_per_year) %>%
  mutate(power = furrr::future_map2(n_years, samples_per_year,
                                    ~power_ken(r, mu, percent_change,
                                               .x, .y)))
output %>%
  tidyr::unnest(power) %>%
  mutate(p.change = percent_change) -> output.15



power_chart <- bind_rows(output.20, output.15)


ggplot(power_chart %>% mutate(p.change = as.factor(p.change))) +
  geom_point(aes(samples_per_year, power, color = p.change, group = p.change)) +
  geom_line(aes(samples_per_year, power, color = p.change, group = p.change))
ggsave("example.png", width = 4, height = 2, units = "in", dpi = 200)
